# API 接口文档

> 记录当前应用提供的所有 API 接口，包含 URL、方法、入参、返回值和调用示例。
> 每步开发新增接口时同步更新本文档。

## 环境地址

| 环境 | Base URL |
|------|----------|
| 生产环境 | `https://ai-coding-museum-production.up.railway.app` |
| 本地开发 | `http://localhost:3000` |

> 以下文档示例使用本地开发地址，生产环境请替换为生产环境 Base URL。

**CORS 配置**：服务端已启用 CORS，允许前端地址由环境变量 `CORS_ORIGIN` 控制（默认 `http://localhost:5173`），并开启 `credentials: true` 以支持跨域携带 Cookie。

**错误响应规范（业务接口）**：`/api/posts`、`/api/users` 等业务接口统一使用 `{ code, message }` 格式，详见《技术框架设计》→ API 错误响应规范。认证接口 `/api/auth/*` 由 BetterAuth 提供，格式一致。

---

## 一、健康检查

### GET /health

检查服务运行状态和数据库连接状态。

**请求**：无需参数

**返回值**：
```json
{
  "status": "ok",
  "timestamp": "2026-02-18T13:57:37.651Z",
  "database": "connected"
}
```

| 字段 | 类型 | 说明 |
|------|------|------|
| status | string | 固定 `"ok"` |
| timestamp | string | 当前服务器时间（ISO 8601） |
| database | string | `"connected"` 或 `"disconnected"` |

**curl 示例**：
```bash
curl http://localhost:3000/health
```

---

## 二、用户认证（BetterAuth）

> 认证接口由 BetterAuth 框架提供，统一前缀 `/api/auth`。
> 会话通过 HttpOnly Cookie（`better-auth.session_token`）管理，有效期 7 天。
>
> **前端接入**：前端使用 `@better-auth/client` SDK 与后端对接登录验证的部分，SDK 会自动处理 Cookie 管理和会话状态，返回统一的 `{ data, error }` 结构。以下 `curl` 示例仅用于后端手动验证。

### 错误响应格式

BetterAuth 路由（`/api/auth/*`）的错误响应统一使用以下结构：

```json
{
  "code": "ERROR_CODE",
  "message": "人类可读的错误描述"
}
```

> 注意：业务接口（/api/posts、/api/users 等）通过全局 ExceptionFilter 输出相同格式，前端可统一解析。

**已知错误码清单**：

| HTTP 状态码 | code | message | 触发场景 |
|------------|------|---------|---------|
| 400 | `VALIDATION_ERROR` | `[body.email] Invalid email address` | 邮箱格式无效 |
| 400 | `VALIDATION_ERROR` | `[body.name] Invalid input: expected string, received undefined` | 缺少必填字段 |
| 400 | `PASSWORD_TOO_SHORT` | `Password too short` | 密码少于 8 位 |
| 401 | `INVALID_EMAIL_OR_PASSWORD` | `Invalid email or password` | 登录时邮箱不存在或密码错误 |
| 422 | `USER_ALREADY_EXISTS_USE_ANOTHER_EMAIL` | `User already exists. Use another email.` | 注册时邮箱已被使用 |

> `get-session` 在 token 无效或过期时返回 **HTTP 200 + `null`**（不是 401）。

### POST /api/auth/sign-up/email

邮箱密码注册新用户。

**请求头**：
```
Content-Type: application/json
```

**请求体**：
```json
{
  "name": "测试用户",
  "email": "test@example.com",
  "password": "Test123456!"
}
```

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| name | string | ✅ | 用户显示名称（允许空字符串） |
| email | string | ✅ | 邮箱地址（全局唯一，需符合邮箱格式） |
| password | string | ✅ | 密码（最少 8 位，无复杂度要求；BetterAuth 自动加盐哈希存储） |

**成功返回**（HTTP 200）：
```json
{
  "token": "h3TTLhTNzx8cwnUPNN12YdscZs8t7Sxo",
  "user": {
    "id": "gpSBZwZ6TukPWxGh4X3WRJPACAKaXF91",
    "name": "测试用户",
    "email": "test@example.com",
    "emailVerified": false,
    "image": null,
    "createdAt": "2026-02-18T13:57:49.260Z",
    "updatedAt": "2026-02-18T13:57:49.260Z"
  }
}
```

**响应头**：
```
set-cookie: better-auth.session_token=<token>.<HMAC签名>; Max-Age=604800; Path=/; HttpOnly; SameSite=Lax
```

> 注册成功后**自动登录**：响应中同时设置会话 Cookie，前端无需再调用 sign-in 接口。

**失败场景**：
| HTTP 状态码 | code | 场景 |
|------------|------|------|
| 400 | `VALIDATION_ERROR` | 邮箱格式无效 / 缺少必填字段 |
| 400 | `PASSWORD_TOO_SHORT` | 密码少于 8 位 |
| 422 | `USER_ALREADY_EXISTS_USE_ANOTHER_EMAIL` | 邮箱已被注册 |

**curl 示例**：
```bash
curl -X POST http://localhost:3000/api/auth/sign-up/email \
  -H "Content-Type: application/json" \
  -d '{"name":"测试用户","email":"test@example.com","password":"Test123456!"}'
```

---

### POST /api/auth/sign-in/email

邮箱密码登录。

**请求头**：
```
Content-Type: application/json
```

**请求体**：
```json
{
  "email": "test@example.com",
  "password": "Test123456!"
}
```

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| email | string | ✅ | 注册时的邮箱 |
| password | string | ✅ | 密码 |

**成功返回**（HTTP 200）：
```json
{
  "redirect": false,
  "token": "4YMeifbwSqqjKZDcYmCvgj7J6PQ1J26l",
  "user": {
    "id": "gpSBZwZ6TukPWxGh4X3WRJPACAKaXF91",
    "name": "测试用户",
    "email": "test@example.com",
    "emailVerified": false,
    "image": null,
    "createdAt": "2026-02-18T13:57:49.260Z",
    "updatedAt": "2026-02-18T13:57:49.260Z"
  }
}
```

**响应头**（关键）：
```
set-cookie: better-auth.session_token=<token>.<HMAC签名>; Max-Age=604800; Path=/; HttpOnly; SameSite=Lax
```

> ⚠️ **重要区别**：
> - JSON 响应体的 `token` 字段：仅包含 session token 标识（如 `w4aYWnc1SeR7NGKAT5uTBAofPFdB7NJV`）
> - `Set-Cookie` 响应头的值：包含 `token.HMAC签名`（如 `w4aYWnc1SeR7NGKAT5uTBAofPFdB7NJV.5q3qW3AuvJlJTfMu8Q0FC4ytKjWWc4hNPJkFanluGUo%3D`）
>
> **`get-session` 接口必须使用 `Set-Cookie` 中的完整值（含 `.` 后的签名），不能使用 JSON body 中的 `token`，否则会返回 `null`。**
>
> 推荐使用 `curl -c tmp/cookies.txt` 自动保存 cookie，再用 `curl -b tmp/cookies.txt` 发送，避免手动复制出错。

**失败场景**：
| HTTP 状态码 | code | 场景 |
|------------|------|------|
| 401 | `INVALID_EMAIL_OR_PASSWORD` | 邮箱不存在或密码错误 |

**curl 示例**：
```bash
# 登录并保存 Cookie 到文件
curl -X POST http://localhost:3000/api/auth/sign-in/email \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"Test123456!"}' \
  -c tmp/cookies.txt -v

# -c tmp/cookies.txt 会将响应中的 Set-Cookie 保存到 tmp/cookies.txt 文件
# -v 显示详细信息，可以看到 Set-Cookie 响应头
```

---

### GET /api/auth/get-session

获取当前登录用户的会话信息。需要携带登录时返回的 Cookie。

**请求头**：
```
Cookie: better-auth.session_token=<登录时 Set-Cookie 响应头中的完整值，含 .签名>
```

> ⚠️ 必须使用 `Set-Cookie` 中的完整值，不是 JSON 响应体中的 `token` 字段。推荐用 `-b tmp/cookies.txt` 方式。

**成功返回**（HTTP 200，已登录）：
```json
{
  "session": {
    "id": "nBOKlnXhca5B4DbXGqDe09R3V8LeaNin",
    "expiresAt": "2026-02-25T13:58:29.558Z",
    "token": "oNkdVUMX5BH9DvOozdhYMytK4PTLph82",
    "createdAt": "2026-02-18T13:58:29.558Z",
    "updatedAt": "2026-02-18T13:58:29.558Z",
    "ipAddress": "",
    "userAgent": "curl/8.7.1",
    "userId": "gpSBZwZ6TukPWxGh4X3WRJPACAKaXF91"
  },
  "user": {
    "id": "gpSBZwZ6TukPWxGh4X3WRJPACAKaXF91",
    "name": "测试用户",
    "email": "test@example.com",
    "emailVerified": false,
    "image": null,
    "createdAt": "2026-02-18T13:57:49.260Z",
    "updatedAt": "2026-02-18T13:57:49.260Z"
  }
}
```

**未登录返回**（HTTP 200）：
```json
null
```

**curl 示例**：
```bash
# 方式一：使用之前保存的 tmp/cookies.txt 文件
curl http://localhost:3000/api/auth/get-session -b tmp/cookies.txt

# 方式二：手动传递 Cookie 值（从登录响应的 Set-Cookie 头中复制）
curl http://localhost:3000/api/auth/get-session \
  -H "Cookie: better-auth.session_token=<从登录响应中复制的完整值>"
```

---

### POST /api/auth/sign-out

退出登录，清除会话 Cookie。

**请求头**：
```
Cookie: better-auth.session_token=<当前会话的cookie值>
```

> 推荐用 `-b tmp/cookies.txt` 方式传递 Cookie。

**成功返回**（HTTP 200）：
```json
{
  "success": true
}
```

**响应头**（清除 Cookie）：
```
set-cookie: better-auth.session_token=; Max-Age=0; Path=/; HttpOnly; SameSite=Lax
set-cookie: better-auth.session_data=; Max-Age=0; Path=/; HttpOnly; SameSite=Lax
set-cookie: better-auth.dont_remember=; Max-Age=0; Path=/; HttpOnly; SameSite=Lax
```

> `Max-Age=0` 表示立即过期，浏览器会自动清除这些 Cookie。

**curl 示例**：
```bash
curl -X POST http://localhost:3000/api/auth/sign-out -b tmp/cookies.txt
```

---

## 三、对象存储（R2）

> 以下接口需登录，携带 Cookie：`-b tmp/cookies.txt`。错误格式统一为 `{ code, message }`。

### GET /api/storage/upload-url

获取上传预签名 URL，前端获取后直接 PUT 上传文件到 R2。

**请求头**：
```
Cookie: better-auth.session_token=<登录后 Set-Cookie 中的完整值>
```

**Query 参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| filename | string | ✅ | 原始文件名 |
| contentType | string | ✅ | 文件 MIME 类型 |

**支持的文件类型**：

| 类型 | MIME 类型 | 最大大小 |
|------|-----------|----------|
| 图片 | image/jpeg, image/png, image/gif, image/webp | 5MB |
| 视频 | video/mp4, video/webm | 50MB |

**成功返回**（HTTP 200）：
```json
{
  "uploadUrl": "https://xxx.r2.cloudflarestorage.com/uploads/userId/uuid.jpg?X-Amz-Algorithm=...",
  "objectKey": "uploads/userId/uuid.jpg",
  "publicUrl": "https://pub-xxx.r2.dev/uploads/userId/uuid.jpg"
}
```

| 字段 | 类型 | 说明 |
|------|------|------|
| uploadUrl | string | 预签名上传 URL，有效期 15 分钟 |
| objectKey | string | 存储路径 |
| publicUrl | string | 上传成功后的公开访问 URL |

**失败场景**：

| HTTP 状态码 | code | 触发条件 |
|------------|------|----------|
| 401 | UNAUTHORIZED | 未登录或会话过期 |
| 400 | BAD_REQUEST | 缺少 filename 或 contentType |
| 400 | BAD_REQUEST | 不支持的文件类型 |

**curl 示例**：
```bash
curl "http://localhost:3000/api/storage/upload-url?filename=test.jpg&contentType=image/jpeg" -b tmp/cookies.txt
```

**前端上传流程**：
```javascript
// 1. 获取预签名 URL
const res = await fetch('/api/storage/upload-url?filename=test.jpg&contentType=image/jpeg');
const { uploadUrl, publicUrl } = await res.json();

// 2. 直接上传到 R2
await fetch(uploadUrl, {
  method: 'PUT',
  headers: { 'Content-Type': 'image/jpeg' },
  body: file,
});

// 3. 发帖时使用 publicUrl
await fetch('/api/posts', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ content: '带图片的帖子', mediaUrls: [publicUrl] }),
});
```

---

## 四、内容与用户（业务接口）

> 以下接口需登录，携带 Cookie：`-b tmp/cookies.txt`。错误格式统一为 `{ code, message }`。

### POST /api/posts

发帖（支持纯文本和媒体）。

**请求头**：
```
Content-Type: application/json
Cookie: better-auth.session_token=<登录后 Set-Cookie 中的完整值>
```

**请求体**：
```json
{
  "content": "hello",
  "mediaUrls": ["https://pub-xxx.r2.dev/uploads/userId/uuid.jpg"]
}
```

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| content | string | ✅ | 正文，不能为空 |
| mediaUrls | string[] | 否 | 已上传媒体的公开 URL 数组（需先调用 `/api/storage/upload-url` 上传） |

**成功返回**（HTTP 201）：
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "userId": "gpSBZwZ6TukPWxGh4X3WRJPACAKaXF91",
  "content": "hello",
  "mediaUrls": ["https://pub-xxx.r2.dev/uploads/userId/uuid.jpg"],
  "createdAt": "2026-02-23T12:00:00.000Z",
  "updatedAt": "2026-02-23T12:00:00.000Z"
}
```

**失败场景**：

| HTTP 状态码 | code | 触发条件 |
|------------|------|----------|
| 401 | UNAUTHORIZED | 未登录或会话过期 |
| 400 | BAD_REQUEST | content 为空或缺失 |

**curl 示例**：
```bash
# 纯文本发帖
curl -X POST http://localhost:3000/api/posts \
  -H "Content-Type: application/json" \
  -b tmp/cookies.txt \
  -d '{"content":"hello"}'

# 带媒体发帖
curl -X POST http://localhost:3000/api/posts \
  -H "Content-Type: application/json" \
  -b tmp/cookies.txt \
  -d '{"content":"带图片的帖子","mediaUrls":["https://pub-xxx.r2.dev/uploads/userId/uuid.jpg"]}'
```

---

### GET /api/posts

时间流分页。

**请求头**：
```
Cookie: better-auth.session_token=<登录后 Set-Cookie 中的完整值>
```

**Query 参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| cursor | string | 否 | 上一页最后一条的 post.id，用于游标分页 |
| limit | number | 否 | 每页条数，默认 10，最大 50 |

**成功返回**（HTTP 200）：
```json
[
  {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "userId": "gpSBZwZ6TukPWxGh4X3WRJPACAKaXF91",
    "content": "hello",
    "mediaUrls": null,
    "createdAt": "2026-02-23T12:00:00.000Z",
    "updatedAt": "2026-02-23T12:00:00.000Z",
    "authorName": "测试用户",
    "authorImage": null
  }
]
```

**失败场景**：

| HTTP 状态码 | code | 触发条件 |
|------------|------|----------|
| 401 | UNAUTHORIZED | 未登录或会话过期 |

**curl 示例**：
```bash
curl "http://localhost:3000/api/posts?limit=10" -b tmp/cookies.txt
```

---

### POST /api/posts/:id/like

点赞/取消点赞（toggle）。

**请求头**：
```
Cookie: better-auth.session_token=<登录后 Set-Cookie 中的完整值>
```

**路径参数**：`id` — post 的 UUID

**成功返回**（HTTP 200）：
```json
{"liked": true}
```
或
```json
{"liked": false}
```

**失败场景**：

| HTTP 状态码 | code | 触发条件 |
|------------|------|----------|
| 401 | UNAUTHORIZED | 未登录或会话过期 |
| 404 | NOT_FOUND | post 不存在 |

**curl 示例**：
```bash
curl -X POST http://localhost:3000/api/posts/550e8400-e29b-41d4-a716-446655440000/like -b tmp/cookies.txt
```

---

### GET /api/users/me

当前登录用户信息。

**请求头**：
```
Cookie: better-auth.session_token=<登录后 Set-Cookie 中的完整值>
```

**成功返回**（HTTP 200）：
```json
{
  "id": "gpSBZwZ6TukPWxGh4X3WRJPACAKaXF91",
  "name": "测试用户",
  "email": "test@example.com",
  "emailVerified": false,
  "image": null,
  "createdAt": "2026-02-18T13:57:49.260Z",
  "updatedAt": "2026-02-18T13:57:49.260Z"
}
```

**失败场景**：

| HTTP 状态码 | code | 触发条件 |
|------------|------|----------|
| 401 | UNAUTHORIZED | 未登录或会话过期 |

**curl 示例**：
```bash
curl http://localhost:3000/api/users/me -b tmp/cookies.txt
```

---

### GET /api/users/:id

他人用户信息（脱敏，不返回 email）。

**请求头**：
```
Cookie: better-auth.session_token=<登录后 Set-Cookie 中的完整值>
```

**路径参数**：`id` — 用户 ID

**成功返回**（HTTP 200）：
```json
{
  "id": "gpSBZwZ6TukPWxGh4X3WRJPACAKaXF91",
  "name": "测试用户",
  "image": null,
  "createdAt": "2026-02-18T13:57:49.260Z"
}
```

**失败场景**：

| HTTP 状态码 | code | 触发条件 |
|------------|------|----------|
| 401 | UNAUTHORIZED | 未登录或会话过期 |
| 404 | NOT_FOUND | 用户不存在 |

**curl 示例**：
```bash
curl http://localhost:3000/api/users/gpSBZwZ6TukPWxGh4X3WRJPACAKaXF91 -b tmp/cookies.txt
```

---

## 五、手动验证完整流程

### 前置条件
1. 确保 `.env` 中配置了 `DATABASE_URL`、`AUTH_SECRET`、`BETTER_AUTH_URL`
2. 确保已执行数据库迁移（`npx drizzle-kit generate && npx drizzle-kit migrate`）

### 步骤

```bash
# 1. 启动服务
npm run build && node dist/main.js

# 2. 健康检查
curl http://localhost:3000/health
# 预期：{"status":"ok","timestamp":"...","database":"connected"}

# 3. 注册用户
curl -X POST http://localhost:3000/api/auth/sign-up/email \
  -H "Content-Type: application/json" \
  -d '{"name":"测试用户","email":"test@example.com","password":"Test123456!"}'
# 预期：返回 { token, user: { id, name, email, ... } }

# 4. 登录（保存 Cookie）
curl -X POST http://localhost:3000/api/auth/sign-in/email \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"Test123456!"}' \
  -c tmp/cookies.txt
# 预期：返回用户信息，tmp/cookies.txt 中保存了会话 Cookie

# 5. 获取会话（验证 Cookie 认证）
curl http://localhost:3000/api/auth/get-session -b tmp/cookies.txt
# 预期：返回 { session: {...}, user: {...} }

# 6. 登出
curl -X POST http://localhost:3000/api/auth/sign-out -b tmp/cookies.txt
# 预期：返回 { "success": true }

# 7. 验证登出生效
curl http://localhost:3000/api/auth/get-session -b tmp/cookies.txt
# 预期：返回 null（会话已失效）

# 8. 清理（可选）：停止服务后删除临时文件
rm -f tmp/cookies.txt
```

---

## 六、评论系统

> 以下接口需登录，携带 Cookie：`-b tmp/cookies.txt`。错误格式统一为 `{ code, message }`。

### POST /api/posts/:postId/comments

发表评论或回复（支持楼中楼，最多5层嵌套）。

**请求头**：
```
Content-Type: application/json
Cookie: better-auth.session_token=<登录后 Set-Cookie 中的完整值>
```

**路径参数**：`postId` — 帖子的 UUID

**请求体**：
```json
{
  "content": "这是一条评论",
  "parentId": "可选，回复时填写父评论ID"
}
```

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| content | string | ✅ | 评论内容，不能为空 |
| parentId | string | 否 | 父评论ID，填写则为回复（楼中楼） |

**成功返回**（HTTP 201）：
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "postId": "帖子UUID",
  "userId": "用户ID",
  "content": "这是一条评论",
  "parentId": null,
  "depth": 0,
  "likeCount": 0,
  "createdAt": "2026-03-01T12:00:00.000Z",
  "updatedAt": "2026-03-01T12:00:00.000Z",
  "deletedAt": null
}
```

| 字段 | 类型 | 说明 |
|------|------|------|
| depth | number | 嵌套深度（0-4，共5层） |
| parentId | string | null 为顶级评论，否则为回复 |

**失败场景**：

| HTTP 状态码 | code | 触发条件 |
|------------|------|----------|
| 401 | UNAUTHORIZED | 未登录或会话过期 |
| 404 | NOT_FOUND | 帖子不存在 |
| 404 | NOT_FOUND | 父评论不存在 |
| 400 | BAD_REQUEST | 超过5层嵌套 |
| 400 | BAD_REQUEST | 回复已删除的评论 |

**curl 示例**：
```bash
# 发表顶级评论
curl -X POST http://localhost:3000/api/posts/550e8400-e29b-41d4-a716-446655440000/comments \
  -H "Content-Type: application/json" \
  -b tmp/cookies.txt \
  -d '{"content":"这是一条评论"}'

# 回复评论（楼中楼）
curl -X POST http://localhost:3000/api/posts/550e8400-e29b-41d4-a716-446655440000/comments \
  -H "Content-Type: application/json" \
  -b tmp/cookies.txt \
  -d '{"content":"回复内容","parentId":"父评论UUID"}'
```

---

### GET /api/posts/:postId/comments

获取评论列表（树形结构）。

**请求头**：
```
Cookie: better-auth.session_token=<登录后 Set-Cookie 中的完整值>
```

**路径参数**：`postId` — 帖子的 UUID

**Query 参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| limit | number | 否 | 返回数量，默认 20，最大 50 |

**成功返回**（HTTP 200）：
```json
[
  {
    "id": "评论UUID",
    "postId": "帖子UUID",
    "userId": "用户ID",
    "content": "评论内容",
    "parentId": null,
    "depth": 0,
    "likeCount": 5,
    "createdAt": "2026-03-01T12:00:00.000Z",
    "updatedAt": "2026-03-01T12:00:00.000Z",
    "deletedAt": null,
    "authorName": "用户名",
    "authorImage": null,
    "isLiked": false,
    "replies": [
      {
        "id": "回复UUID",
        "content": "回复内容",
        "depth": 1,
        "replies": []
      }
    ]
  }
]
```

**排序规则**：
- 顶级评论：按点赞数倒序，点赞数相同时按时间倒序
- 嵌套回复：按时间正序（保持对话顺序）

**失败场景**：

| HTTP 状态码 | code | 触发条件 |
|------------|------|----------|
| 401 | UNAUTHORIZED | 未登录或会话过期 |

**curl 示例**：
```bash
curl "http://localhost:3000/api/posts/550e8400-e29b-41d4-a716-446655440000/comments?limit=20" -b tmp/cookies.txt
```

---

### POST /api/comments/:id/like

点赞/取消点赞评论（toggle）。

**请求头**：
```
Cookie: better-auth.session_token=<登录后 Set-Cookie 中的完整值>
```

**路径参数**：`id` — 评论的 UUID

**成功返回**（HTTP 200）：
```json
{"liked": true}
```
或
```json
{"liked": false}
```

**失败场景**：

| HTTP 状态码 | code | 触发条件 |
|------------|------|----------|
| 401 | UNAUTHORIZED | 未登录或会话过期 |
| 404 | NOT_FOUND | 评论不存在 |
| 400 | BAD_REQUEST | 评论已删除 |

**curl 示例**：
```bash
curl -X POST http://localhost:3000/api/comments/550e8400-e29b-41d4-a716-446655440000/like -b tmp/cookies.txt
```

---

### DELETE /api/comments/:id

删除评论（软删除）。仅作者本人或帖主可删除。

**请求头**：
```
Cookie: better-auth.session_token=<登录后 Set-Cookie 中的完整值>
```

**路径参数**：`id` — 评论的 UUID

**成功返回**（HTTP 200）：
```json
{"deleted": true}
```

**失败场景**：

| HTTP 状态码 | code | 触发条件 |
|------------|------|----------|
| 401 | UNAUTHORIZED | 未登录或会话过期 |
| 404 | NOT_FOUND | 评论不存在 |
| 403 | FORBIDDEN | 非作者且非帖主 |
| 400 | BAD_REQUEST | 评论已删除 |

**curl 示例**：
```bash
curl -X DELETE http://localhost:3000/api/comments/550e8400-e29b-41d4-a716-446655440000 -b tmp/cookies.txt
```

---

## 七、用户关注

> 以下接口需登录，携带 Cookie：`-b tmp/cookies.txt`。错误格式统一为 `{ code, message }`。

### POST /api/users/:id/follow

关注用户。

**请求头**：
```
Cookie: better-auth.session_token=<登录后 Set-Cookie 中的完整值>
```

**路径参数**：`id` — 目标用户 ID

**成功返回**（HTTP 200）：
```json
{"following": true}
```

**失败场景**：

| HTTP 状态码 | code | 触发条件 |
|------------|------|----------|
| 401 | UNAUTHORIZED | 未登录或会话过期 |
| 400 | BAD_REQUEST | 不能关注自己 |
| 400 | BAD_REQUEST | 用户不存在 |

**curl 示例**：
```bash
curl -X POST http://localhost:3000/api/users/目标用户ID/follow -b tmp/cookies.txt
```

---

### DELETE /api/users/:id/follow

取消关注用户。

**请求头**：
```
Cookie: better-auth.session_token=<登录后 Set-Cookie 中的完整值>
```

**路径参数**：`id` — 目标用户 ID

**成功返回**（HTTP 200）：
```json
{"following": false}
```

**curl 示例**：
```bash
curl -X DELETE http://localhost:3000/api/users/目标用户ID/follow -b tmp/cookies.txt
```

---

### GET /api/users/:id/following

获取用户的关注列表。

**请求头**：
```
Cookie: better-auth.session_token=<登录后 Set-Cookie 中的完整值>
```

**路径参数**：`id` — 用户 ID

**Query 参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| limit | number | 否 | 返回数量，默认 20，最大 50 |
| offset | number | 否 | 偏移量，用于分页 |

**成功返回**（HTTP 200）：
```json
[
  {
    "id": "被关注用户ID",
    "name": "用户名",
    "image": null,
    "createdAt": "关注时间"
  }
]
```

**curl 示例**：
```bash
curl "http://localhost:3000/api/users/用户ID/following?limit=20" -b tmp/cookies.txt
```

---

### GET /api/users/:id/followers

获取用户的粉丝列表。

**请求头**：
```
Cookie: better-auth.session_token=<登录后 Set-Cookie 中的完整值>
```

**路径参数**：`id` — 用户 ID

**Query 参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| limit | number | 否 | 返回数量，默认 20，最大 50 |
| offset | number | 否 | 偏移量，用于分页 |

**成功返回**（HTTP 200）：
```json
[
  {
    "id": "粉丝用户ID",
    "name": "用户名",
    "image": null,
    "createdAt": "关注时间"
  }
]
```

**curl 示例**：
```bash
curl "http://localhost:3000/api/users/用户ID/followers?limit=20" -b tmp/cookies.txt
```

---

### GET /api/feed/following

获取关注时间流（仅返回已关注用户的帖子）。

**请求头**：
```
Cookie: better-auth.session_token=<登录后 Set-Cookie 中的完整值>
```

**Query 参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| limit | number | 否 | 返回数量，默认 10，最大 50 |
| cursor | string | 否 | 游标，上一页最后一条的 post.id |

**成功返回**（HTTP 200）：
```json
[
  {
    "id": "帖子UUID",
    "userId": "作者ID",
    "content": "帖子内容",
    "mediaUrls": null,
    "createdAt": "2026-03-01T12:00:00.000Z",
    "authorName": "作者名",
    "authorImage": null
  }
]
```

> 如果未关注任何人，返回空数组 `[]`

**curl 示例**：
```bash
curl "http://localhost:3000/api/feed/following?limit=10" -b tmp/cookies.txt
```

---

## 八、用户信息扩展

> 用户信息接口已扩展，增加关注数/粉丝数/关注状态字段。

### GET /api/users/me（更新）

**成功返回**（HTTP 200）：
```json
{
  "id": "用户ID",
  "name": "用户名",
  "email": "email@example.com",
  "emailVerified": false,
  "image": null,
  "createdAt": "2026-03-01T12:00:00.000Z",
  "updatedAt": "2026-03-01T12:00:00.000Z",
  "followingCount": 10,
  "followersCount": 5
}
```

| 新增字段 | 类型 | 说明 |
|---------|------|------|
| followingCount | number | 关注数 |
| followersCount | number | 粉丝数 |

---

### GET /api/users/:id（更新）

**成功返回**（HTTP 200）：
```json
{
  "id": "用户ID",
  "name": "用户名",
  "image": null,
  "createdAt": "2026-03-01T12:00:00.000Z",
  "followingCount": 10,
  "followersCount": 5,
  "isFollowing": false
}
```

| 新增字段 | 类型 | 说明 |
|---------|------|------|
| followingCount | number | 关注数 |
| followersCount | number | 粉丝数 |
| isFollowing | boolean | 当前用户是否已关注该用户 |
