# 开发进度日志

> 记录每步开发的推进状态，便于复盘与接续开发。

---

## 第一步：工程初始化与基础配置

- **状态**：✅ 已完成
- **完成时间**：2026-02-16
- **Git Commit**：`71f7e2d`
- **交付物**：
  - NestJS 工程骨架（可编译、可运行）
  - 健康检查接口 `GET /health` → `{ status: "ok", timestamp: "..." }`
  - 全量依赖声明（NestJS、Drizzle、BetterAuth、Neon、Upstash、R2）
  - 配置文件：`tsconfig.json`、`tsconfig.build.json`、`nest-cli.json`
  - 安全基线：`.gitignore`（增强）、`.env.example`、`SECURITY.md`
  - 容器化：`Dockerfile`（Node 22 Alpine 多阶段构建）
- **验证记录**：

  **1. 依赖安装**
  ```bash
  npm install
  ```
  > ✅ added 486 packages

  **2. 编译验证**
  ```bash
  npm run build
  ```
  > ✅ 编译成功，无错误输出，产物输出至 `dist/`

  **3. 服务启动 + 健康检查**
  ```bash
  npm run start
  # 另开终端：
  curl http://localhost:3000/health
  ```
  ```json
  {"status":"ok","timestamp":"2026-02-16T12:00:00.000Z"}
  ```
  > ✅ HTTP 200

  **4. Docker 构建**
  ```bash
  docker build -t ai-coding-museum .
  ```
  > ✅ 多阶段构建成功（Node 22 Alpine），镜像加速源：`https://docker.xuanyuan.me`

  **5. Docker 容器运行 + 健康检查**
  ```bash
  docker run -d -p 3000:3000 --env-file .env ai-coding-museum
  curl http://localhost:3000/health
  ```
  ```json
  {"status":"ok","timestamp":"2026-02-16T12:05:00.000Z"}
  ```
  > ✅ 容器内服务正常响应

- **备注**：
  - Docker 镜像加速源通过 OrbStack Settings → Docker → Engine 配置
  - 时间戳为近似值，实际值随运行时变化
- **设计详情**：见《技术框架设计》文档 → 第一步

---

## 第二步：数据库接入与 Drizzle ORM 配置

- **状态**：✅ 已完成
- **完成时间**：2026-02-18
- **Git Commit**：`a988a20`
- **交付物**：
  - 数据库模块 `DatabaseModule`（全局，Drizzle + Neon HTTP 驱动）
  - Drizzle Provider（`@Inject(DRIZZLE)` 注入模式）
  - Schema 骨架（`src/database/schema/index.ts`）
  - Drizzle Kit 迁移配置（`drizzle.config.ts`）
  - 健康检查接口增加数据库连接状态 `database: "connected" | "disconnected"`
- **验证记录**：

  **1. 编译验证**
  ```bash
  npm run build
  ```
  > ✅ 编译成功，无错误输出

  **2. 健康检查（含数据库状态）**
  ```bash
  curl http://localhost:3000/health
  ```
  ```json
  {"status":"ok","database":"connected"}
  ```
  > ✅ HTTP 200，数据库连接正常（Neon PostgreSQL via HTTP driver）

- **设计详情**：见《技术框架设计》文档 → 第二步

---

## 第三步：用户认证系统（BetterAuth + Drizzle）

- **状态**：✅ 已完成
- **完成时间**：2026-02-18
- **Git Commit**：`6c07843`
- **交付物**：
  - 认证模块 `AuthModule`（AuthService + AuthController）
  - BetterAuth 集成（drizzleAdapter + emailAndPassword 策略）
  - 认证 Controller 桥接（`toNodeHandler` 转发 `/api/auth/*` 路由）
  - 数据库 Schema 定义（user、session、account、verification 4 张表）
  - 首次数据库迁移（`drizzle/0000_workable_stone_men.sql`）
  - `.env.example` 新增 `AUTH_SECRET` 和 `BETTER_AUTH_URL` 占位符
- **验证记录**：

  **1. 编译验证**
  ```bash
  npm run build
  ```
  > ✅ 编译成功，无错误输出

  **2. 数据库迁移**
  ```bash
  npx drizzle-kit generate
  npx drizzle-kit migrate
  ```
  > ✅ 生成迁移文件 `drizzle/0000_workable_stone_men.sql`
  >
  > ✅ 迁移执行成功，创建 4 张表：user、session、account、verification

  **3. 用户注册**
  ```bash
  curl -s -X POST http://localhost:3000/api/auth/sign-up/email \
    -H "Content-Type: application/json" \
    -d '{"name":"测试用户","email":"test@example.com","password":"Test123456"}'
  ```
  ```json
  {
    "token": "eyJhbGci...<JWT略>",
    "user": {
      "id": "<UUID>",
      "name": "测试用户",
      "email": "test@example.com",
      "emailVerified": false,
      "image": null,
      "createdAt": "2026-02-18T...",
      "updatedAt": "2026-02-18T..."
    }
  }
  ```
  > ✅ HTTP 200，注册成功，返回用户对象 + token

  **4. 用户登录**
  ```bash
  curl -s -X POST http://localhost:3000/api/auth/sign-in/email \
    -H "Content-Type: application/json" \
    -d '{"email":"test@example.com","password":"Test123456"}' \
    -c tmp/cookies.txt
  ```
  ```json
  {
    "token": "eyJhbGci...<JWT略>",
    "user": {
      "id": "<UUID>",
      "name": "测试用户",
      "email": "test@example.com",
      "emailVerified": false,
      "image": null,
      "createdAt": "2026-02-18T...",
      "updatedAt": "2026-02-18T..."
    }
  }
  ```
  > ✅ HTTP 200，登录成功
  >
  > 响应头包含 `Set-Cookie: better-auth.session_token=<token>.<HMAC签名>; HttpOnly; Path=/; Max-Age=604800; SameSite=Lax`
  >
  > Cookie 已通过 `-c tmp/cookies.txt` 自动保存到文件

  **5. 会话查询**
  ```bash
  curl -s http://localhost:3000/api/auth/get-session -b tmp/cookies.txt
  ```
  ```json
  {
    "session": {
      "id": "<UUID>",
      "userId": "<UUID>",
      "token": "<session_token>",
      "expiresAt": "2026-02-25T...",
      "createdAt": "2026-02-18T...",
      "updatedAt": "2026-02-18T...",
      "ipAddress": "::1",
      "userAgent": "curl/8.x"
    },
    "user": {
      "id": "<UUID>",
      "name": "测试用户",
      "email": "test@example.com",
      "emailVerified": false,
      "image": null,
      "createdAt": "2026-02-18T...",
      "updatedAt": "2026-02-18T..."
    }
  }
  ```
  > ✅ HTTP 200，会话有效，返回完整 session + user 对象

  **6. 健康检查**
  ```bash
  curl http://localhost:3000/health
  ```
  ```json
  {"status":"ok","database":"connected"}
  ```
  > ✅ 服务及数据库均正常

  **7. 测试数据清理**
  > 验证完成后，通过 Neon SQL Editor 手动清理测试数据：
  ```sql
  DELETE FROM session;
  DELETE FROM account;
  DELETE FROM "user" WHERE email = 'test@example.com';
  ```
  > ✅ 4 张表已恢复为空

- **备注**：
  - 返回值中 `<UUID>`、`<JWT略>`、`<token>` 等为脱敏占位，实际为 BetterAuth 自动生成的值
  - 原始测试数据已清理，上述响应体为当时结构的精确还原（字段名和层级完全一致，动态值如 ID/时间戳为代表性值）
- **设计详情**：见《技术框架设计》文档 → 第三步

---

## 第四步：核心业务骨架（内容发布 + 点赞 + 用户信息）

- **状态**：✅ 已完成
- **完成时间**：2026-02-23
- **Git Commit**：`c7a5867`
- **交付物**：
  - 全局 ExceptionFilter（`src/common/http-exception.filter.ts`），统一错误格式 `{ code, message }`
  - 会话鉴权 Guard `AuthGuard`（`src/auth/auth.guard.ts`）
  - posts 模块：POST/GET `/api/posts`、POST `/api/posts/:id/like`
  - users 模块：GET `/api/users/me`、GET `/api/users/:id`
  - 数据库 Schema：post、post_like 表
  - 迁移：`drizzle/0001_wild_mojo.sql`
- **验证记录**：

  **1. 编译验证**
  ```bash
  npm run build
  ```
  > ✅ 编译成功，无错误输出

  **2. 数据库迁移**
  ```bash
  npx drizzle-kit generate
  npx drizzle-kit migrate
  ```
  > ✅ 迁移执行成功，post、post_like 表已创建

  **3. 未登录发帖（预期 HTTP 401）**
  ```bash
  curl -s -X POST http://localhost:3000/api/posts \
    -H "Content-Type: application/json" \
    -d '{"content":"hello"}'
  ```
  ```json
  {"code":"UNAUTHORIZED","message":"未登录或会话已过期"}
  ```
  > ✅ HTTP 401，符合预期

  **4. 已登录发帖（需先登录保存 Cookie）**
  ```bash
  curl -s -X POST http://localhost:3000/api/auth/sign-in/email \
    -H "Content-Type: application/json" \
    -d '{"email":"test@example.com","password":"Test123456!"}' \
    -c tmp/cookies.txt

  curl -s -X POST http://localhost:3000/api/posts \
    -H "Content-Type: application/json" \
    -b tmp/cookies.txt \
    -d '{"content":"hello"}'
  ```
  ```json
  {
    "id": "<UUID>",
    "userId": "<USER_ID>",
    "content": "hello",
    "mediaUrls": null,
    "createdAt": "2026-02-23T...",
    "updatedAt": "2026-02-23T..."
  }
  ```
  > ✅ HTTP 201，返回 post 对象

  **5. 浏览时间流**
  ```bash
  curl -s "http://localhost:3000/api/posts?limit=10" -b tmp/cookies.txt
  ```
  > ✅ HTTP 200，返回 post 数组（可能为空）

  **6. 点赞**
  ```bash
  curl -s -X POST http://localhost:3000/api/posts/<POST_ID>/like -b tmp/cookies.txt
  ```
  ```json
  {"liked":true}
  ```
  > ✅ HTTP 200，toggle 成功

  **7. 当前用户**
  ```bash
  curl -s http://localhost:3000/api/users/me -b tmp/cookies.txt
  ```
  > ✅ HTTP 200，返回 user（含 id,name,email,image）

  **8. 他人信息**
  ```bash
  curl -s http://localhost:3000/api/users/<USER_ID> -b tmp/cookies.txt
  ```
  > ✅ HTTP 200，返回脱敏 user（无 email）

- **设计详情**：见《技术框架设计》文档 → 第四步

- **回归验证**（2026-02-26，AI 自行执行）：
  - 结论：**通过**
  - 执行项：编译、未登录 401、注册、登录、发帖、时间流、点赞、当前用户、他人信息、content 空 400、点赞 toggle、post 不存在 404
  - 证据（节选）：未登录发帖 `{"code":"UNAUTHORIZED","message":"未登录或会话已过期"}` HTTP 401；发帖 HTTP 201 返回 post；他人信息无 email 字段；404 返回 `{"code":"NOT_FOUND","message":"帖子不存在"}`

