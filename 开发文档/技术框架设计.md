# 技术框架设计文档

> 本文档记录各步骤的设计方案与决策，采用追加式记录。

---

## 第一步：工程初始化与基础配置

### 【本步目标】
- 交付可运行的 NestJS 工程骨架（含健康检查接口 `GET /health`）
- 一次性声明全部技术栈依赖
- 完成基础配置文件与安全基线

### 【技术方案】

#### 目录结构
```
AI-Coding-Museum/
├── src/
│   ├── main.ts                    # NestJS 入口（端口通过 process.env.PORT 读取，默认 3000）
│   ├── app.module.ts              # 根模块（集成 ConfigModule 全局环境变量管理）
│   └── health/
│       ├── health.controller.ts   # GET /health → { status, timestamp }
│       └── health.module.ts       # 健康检查模块
├── package.json                   # 全量依赖声明
├── tsconfig.json                  # TypeScript 配置（target: ES2022, decorators 支持）
├── tsconfig.build.json            # 构建配置（排除测试文件）
├── nest-cli.json                  # NestJS CLI 配置（编译输出 dist/）
├── .env.example                   # 环境变量模板（仅占位符）
├── .gitignore                     # 排除 .env、*.key、secrets/、dist/
├── SECURITY.md                    # 安全说明（环境变量管理规范）
└── Dockerfile                     # 多阶段构建（Node 22 Alpine）
```

#### 依赖清单
| 类型 | 包名 | 用途 |
|------|------|------|
| dependencies | `@nestjs/core`, `@nestjs/common`, `@nestjs/platform-express` | NestJS 核心（Express 为底层 HTTP 引擎） |
| dependencies | `@nestjs/config` | 环境变量管理 |
| dependencies | `reflect-metadata`, `rxjs` | NestJS 运行时依赖 |
| dependencies | `drizzle-orm` | ORM 核心 |
| dependencies | `better-auth` | 鉴权系统 |
| dependencies | `@neondatabase/serverless` | Neon PostgreSQL 驱动 |
| dependencies | `@upstash/redis` | Upstash Redis 客户端 |
| dependencies | `@aws-sdk/client-s3` | Cloudflare R2 对象存储（S3 兼容） |
| devDependencies | `typescript`, `ts-node`, `tsconfig-paths` | TypeScript 工具链 |
| devDependencies | `@nestjs/cli` | NestJS CLI |
| devDependencies | `@types/node`, `@types/express` | 类型定义 |
| devDependencies | `drizzle-kit` | Schema 迁移工具 |

#### 关键设计决策
1. **Express 作为 NestJS 底层 HTTP 引擎**：NestJS 必须选择 Express 或 Fastify 之一，Express 为默认选项，生态最成熟。业务代码不直接调用 Express API，无需在技术栈选型文档中单独列出。
2. **ConfigModule 全局注入**：`isGlobal: true` 确保所有模块可直接注入 `ConfigService`，统一管理环境变量。
3. **Dockerfile Day 1 就绪**：遵循技术栈方案"容器化隔离"要求，多阶段构建确保生产镜像最小化。

#### 外部服务依赖
本步无（纯骨架验证）

### 【需您准备】
- [x] 变量名：`PORT` | 用途：HTTP 服务端口 | 获取方式：自定义，代码默认值为 3000

### 【安全验证点】
- ✅ 代码中无硬编码密钥（端口通过 `process.env.PORT` 读取）
- ✅ `.gitignore` 已排除 `.env`、`*.key`、`secrets/`、`dist/`
- ✅ `.env.example` 仅含变量名 + 尖括号占位符，无真实值
- ✅ `SECURITY.md` 已提供
- ✅ 未引用 `demo/` 中的任何代码

### 【测试方案与结果】
| 步骤 | 命令 | 预期 | 结果 |
|------|------|------|------|
| 安装依赖 | `npm install` | 无报错 | ✅ 486 packages 安装成功 |
| 编译 | `npm run build` | 无编译错误 | ✅ 编译成功 |
| 启动服务 | `npm run start` | 控制台输出启动信息 | ✅ 正常启动 |
| 健康检查 | `curl http://localhost:3000/health` | HTTP 200, `{ status, timestamp }` | ✅ `{"status":"ok","timestamp":"2026-02-16T10:59:24.851Z"}` |
| Docker 构建 | `docker build -t ai-coding-museum .` | 镜像构建成功 | ✅ 14 步全部完成（Node 22 Alpine 多阶段构建） |
| Docker 运行 | `docker run -p 3000:3000 ai-coding-museum` + `curl /health` | 容器内服务正常响应 | ✅ `{"status":"ok","timestamp":"2026-02-18T12:29:39.366Z"}` |

---

## 第二步：数据库接入与 Drizzle ORM 配置

### 【本步目标】
- 完成 Neon PostgreSQL 数据库连接（通过 Drizzle ORM）
- 建立数据库模块（`DatabaseModule`），全局可注入
- 配置 Drizzle Kit 迁移工具
- 健康检查接口增加数据库连接状态

### 【技术方案】

#### 新增目录结构
```
src/
├── database/
│   ├── database.module.ts         # 全局数据库模块（@Global）
│   ├── database.provider.ts       # Drizzle 实例工厂（neon + drizzle-orm/neon-http）
│   └── schema/
│       └── index.ts               # Schema 统一导出（骨架）
drizzle.config.ts                  # Drizzle Kit 迁移配置（根目录）
```

#### 关键设计决策
1. **Neon HTTP 驱动**：使用 `drizzle-orm/neon-http` + `@neondatabase/serverless` 的 `neon()` 函数，走 HTTP 协议连接 Neon，适合 Serverless 场景（无需维护连接池）。
2. **Provider 注入模式**：通过 `Symbol('DRIZZLE')` 作为注入令牌，业务模块使用 `@Inject(DRIZZLE)` 获取 Drizzle 实例。
3. **全局模块**：`DatabaseModule` 标记 `@Global()`，所有模块无需重复导入即可注入数据库实例。
4. **Schema 骨架**：`schema/index.ts` 导出空对象，后续步骤定义表结构时追加导出。

#### 外部服务依赖
- Neon PostgreSQL（通过 `DATABASE_URL` 环境变量连接）

### 【需您准备】
- [x] 变量名：`DATABASE_URL` | 用途：Neon PostgreSQL 连接串 | 获取方式：Neon 控制台

### 【安全验证点】
- ✅ 数据库连接串仅通过 `process.env.DATABASE_URL` 读取
- ✅ `drizzle.config.ts` 同样通过 `process.env.DATABASE_URL!` 读取
- ✅ `.env.example` 中 `DATABASE_URL=<YOUR_NEON_DATABASE_URL>`（仅占位符）
- ✅ `.env` 包含真实值但被 `.gitignore` 排除
- ✅ 未引用 `demo/` 中的任何代码

### 【测试方案与结果】
| 步骤 | 命令 | 预期 | 结果 |
|------|------|------|------|
| 编译 | `npm run build` | 无编译错误 | ✅ 编译成功 |
| 启动服务 | `node dist/main.js` | 无数据库连接错误 | ✅ 正常启动 |
| 健康检查（含DB） | `curl http://localhost:3000/health` | `{ status, timestamp, database: "connected" }` | ✅ `{"status":"ok","timestamp":"2026-02-18T13:11:32.429Z","database":"connected"}` |
